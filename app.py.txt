import streamlit as st
import pandas as pd
import yfinance as yf
import plotly.express as px
import numpy as np
from datetime import datetime

# ConfiguraciÃ³n de la pÃ¡gina
st.set_page_config(page_title="Investor Dashboard", layout="wide")

st.title("ğŸš€ Panel de Control de Inversiones")
st.markdown("IngresÃ¡ tus activos para proyectar a 10 aÃ±os y ver su rendimiento histÃ³rico.")

# --- Sidebar para ingreso de datos ---
st.sidebar.header("ConfiguraciÃ³n de Activos")

if 'lista_instrumentos' not in st.session_state:
    st.session_state.lista_instrumentos = []

with st.sidebar.form("input_form"):
    ticker = st.text_input("Ticker del Instrumento (Ej: AAPL, AL30.BA)", "").upper()
    vencimiento = st.text_input("Vencimiento (opcional)", "N/A")
    tasa_mensual = st.number_input("Tasa Mensual Estimada (%)", min_value=0.0, float_value=1.0, step=0.1)
    
    add_btn = st.form_submit_button("AÃ±adir a la lista")
    if add_btn and ticker:
        if len(st.session_state.lista_instrumentos) < 50:
            st.session_state.lista_instrumentos.append({
                "Ticker": ticker,
                "Vencimiento": vencimiento,
                "Tasa Mensual (%)": tasa_mensual
            })
        else:
            st.error("LÃ­mite de 50 alcanzado")

if st.sidebar.button("Limpiar lista"):
    st.session_state.lista_instrumentos = []
    st.rerun()

# --- Procesamiento de Datos ---
if st.session_state.lista_instrumentos:
    df_input = pd.DataFrame(st.session_state.lista_instrumentos)
    
    resultados = []
    tickers_grafico = []
    
    for _, row in df_input.iterrows():
        # CÃ¡lculo InterÃ©s Compuesto
        tasa = row["Tasa Mensual (%)"] / 100
        proyeccion = 1000 * (1 + tasa)**120
        
        # Obtener Riesgo (Volatilidad)
        try:
            data = yf.download(row["Ticker"], period="1y", progress=False)['Adj Close']
            if not data.empty:
                vol = data.pct_change().std() * np.sqrt(252)
                riesgo = "Bajo ğŸŸ¢" if vol < 0.18 else "Medio ğŸŸ¡" if vol < 0.40 else "Alto ğŸ”´"
                tickers_grafico.append(row["Ticker"])
            else:
                riesgo = "Desconocido âšª"
        except:
            riesgo = "Error âŒ"
            
        resultados.append({
            "Instrumento": row["Ticker"],
            "Vencimiento": row["Vencimiento"],
            "Tasa Mens.": f"{row['Tasa Mensual (%)']}%",
            "Riesgo": riesgo,
            "Valor en 10 aÃ±os ($1000)": round(proyeccion, 2)
        })

    # --- VisualizaciÃ³n ---
    col1, col2 = st.columns([1, 1])

    with col1:
        st.subheader("ğŸ“Š Cuadro Comparativo")
        df_res = pd.DataFrame(resultados)
        st.table(df_res)
        
        # BotÃ³n de Descarga Excel
        csv = df_res.to_csv(index=False).encode('utf-8')
        st.download_button("ğŸ“¥ Descargar Excel (CSV)", csv, "mi_cartera.csv", "text/csv")

    with col2:
        st.subheader("ğŸ“ˆ Rendimiento Ãšltimos 12 Meses")
        if tickers_grafico:
            hist_data = yf.download(tickers_grafico, period="1y", progress=False)['Adj Close']
            rendimiento = (hist_data / hist_data.iloc[0]) * 100
            fig = px.line(rendimiento, labels={'value': 'Rendimiento %', 'Date': 'Fecha'})
            st.plotly_chart(fig, use_container_width=True)

else:
    st.info("AgregÃ¡ tickers en la barra lateral para comenzar.")